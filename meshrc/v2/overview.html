<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Mesh Controller</title>
    <link href="static/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark mb-4">
      <a class="navbar-brand" href="#">Mesh Controller</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" 
            data-target="#navbarCollapse" aria-controls="navbarCollapse" 
            aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarCollapse">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item ">
            <a class="nav-link" href="graph.html">Network Graph</a>
          </li>
            <li class="nav-item active">
            <a class="nav-link" href="overview.html">Device overview</a>
          </li>
          <li class="nav-item ">
            <a class="nav-link" href="config.html">Configuration</a>
          </li>
        </ul>
        <form class="form-inline">
            <select class="custom-select" id="time_relative"
                    onchange="reload_netjson(this.value)">
                <option value="" selected>Now</option>
                <option value="2m">2 minutes ago</option>
                <option value="15m">15 minutes ago</option>
                <option value="1h">1 hour ago</option>
                <option value="12h">12 hour ago</option>
                <option value="24h">24 hour ago</option>
            </select>
        </form>
      </div>
    </nav>
    <main role="main" class="container-fluid" id="content">
        <table class="table" id="table_overview"> </table>
        <script src="static/js/fmt.js"></script>
        <script src="settings.js"></script>
        <script>
            function table_create(table_content){
                tbl = document.getElementById("table_overview")
                tbl.innerHTML = ""
                var header = tbl.createTHead();
                var header_row = header.insertRow(0);
                header_row.insertCell().innerHTML = "Hostname"
                for(var property in properties_active) {
                    header_row.insertCell().innerHTML = properties_active[property][0]
                }

                var nodes = table_content.nodes

                for(node_index in nodes) {
                    var node = nodes[node_index]
                    var tr = tbl.insertRow();
                    tr.insertCell().appendChild(document.createTextNode(node.label));
                    var properties = node.properties
                    if(properties.node_state == "down") {
                        tr.classList.add("table-danger")
                    } else if(properties.node_state == "up-mload") {
                        tr.classList.add("table-warning")
                    }
                    for(var property in properties_active) {
                        var td = tr.insertCell();
                        if(! properties_active[property][1]) {
                            var value = fmt_normal(properties[property])
                        } else { 
                            var value = properties_active[property][1](properties[property])
                        }
                        td.appendChild(document.createTextNode(value));
                    }
                }
            }

            function reload_netjson(timestamp) {
                fetch(netjson_url + '?timestamp=' + timestamp)
                    .then(function(response) {
                      return response.json();
                    })
                    .then(function(netsjon) {
                      table_create(netsjon);
                    });
                if(typeof timestamp == "undefined") {
                    console.log("autoreload on")
                     window.setTimeout(reload_netjson, 30 * 1000);
                } else {
                    console.log("autoreload off")
                }
            }
            window.onload = reload_netjson()
        </script>
    </main>
  </body>
</html>
