<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Mesh Controller</title>
    <link href="static/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark mb-4">
      <a class="navbar-brand" href="#">Mesh Controller</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" 
            data-target="#navbarCollapse" aria-controls="navbarCollapse" 
            aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarCollapse">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item ">
            <a class="nav-link" href="graph.html">Network Graph</a>
          </li>
            <li class="nav-item ">
            <a class="nav-link" href="overview.html">Device overview</a>
          </li>
          <li class="nav-item active">
            <a class="nav-link" href="config.html">Configuration</a>
          </li>
        </ul>
      </div>
    </nav>
    <main role="main" class="container-fluid" id="content">
    <div id="testing"></div>
    <script>
        ubus_url = "http://localhost:8080/ubus"
        ubus_counter = 1
        function $(s) {
            return document.getElementById(s.substring(1));
        }

        function show(s) {
            $(s).style.display = 'block';
        }

        function hide(s) {
            $(s).style.display = 'none';
        }

        function ubus_call(command, argument, params, callback) {
            var request_data = {};
            request_data.jsonrpc = "2.0";
            request_data.id = ubus_counter;
            request_data.method = "call";
            request_data.params = [ ubus_rpc_session, command, argument, params ]
            fetch(ubus_url, {
                method: "POST",
                body: JSON.stringify(request_data)
            })
            .then(function(res){ return res.json(); })
            .then(function(data){ 
                if(typeof callback != "undefined") {
                    callback(data); 
                }
            })
            ubus_counter++;
        }

        function apply_config() {
            var fe = $("#form_config").elements
            for (var i = 0; i < fe.length; i++) {
                if(fe[i].value != "") {
                    ubus_call("meshrc", fe[i].id, fe[i].value)
                }
            }
        }

        function ubus_login_callback(data) {
            if(data.result == 6) {
                alert("Wrong password!")
            } else {
                ubus_rpc_session = data.result[1].ubus_rpc_session
                hide("#form_login")
                show("#form_config")
            }
        }

        function ubus_login() {
            ubus_rpc_session = "00000000000000000000000000000000"
            ubus_call("session", "login", {
                "username": "root", 
                "password": $("#login_password").value 
            }, ubus_login_callback)
        }
    </script>
    <form class="form-signin" id="form_login">
        <h1 class="h3 mb-3 font-weight-normal">Please sign in</h1>
        <label for="inputPassword" class="sr-only">Password</label>
        <input type="password" id="login_password" class="form-control" placeholder="Password" required>
        <br /><a class="btn btn-primary" onclick="ubus_login()" href="#" role="button">Sign in</a>
    </form>

        <form action="config" method="post" id="form_config" style="display: none">
            <div class="form-group row">
                <label for="network_name" class="col-sm-2 col-form-label">Network Name</label>
                <div class="col-sm-6">
                    <input type="text" class="form-control" id="network_name" placeholder="">
                </div>
            </div>
            <div class="form-group row">
                <label for="ap_pass" class="col-sm-2 col-form-label">Access Point Password</label>
                <div class="col-sm-6">
                    <input type="password" class="form-control" id="ap_pass" placeholder="Password">
                </div>
            </div>
            <div class="form-group row">
                <label for="mesh_id" class="col-sm-2 col-form-label">Mesh ID</label>
                <div class="col-sm-6">
                    <input type="text" class="form-control" id="mesh_id" placeholder="">
                </div>
            </div>
            <div class="form-group row">
                <label for="inputPassword" class="col-sm-2 col-form-label">Mesh Password</label>
                <div class="col-sm-6">
                    <input type="password" class="form-control" id="mesh_pass" placeholder="Password">
                </div>
            </div>
            <div class="form-group row">
                <label for="ssh_keys" class="col-sm-2 col-form-label">SSH Keys</label>
                <div class="col-sm-6">
                    <textarea class="form-control" id="ssh_keys" rows="5"></textarea>
                </div>
            </div>
            <div class="form-group row">
                <div class="col-sm-6">
                    <a class="btn btn-primary" href="#" onclick="apply_config()" role="button">Apply</a>
                    <a class="btn btn-danger" href="#" role="button">Reset network</a>
                </div>
            </div>
        </form>
    </main>
  </body>
</html>
